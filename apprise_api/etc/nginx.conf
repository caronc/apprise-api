daemon off;
worker_processes auto;
pid /tmp/apprise/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
   worker_connections 4096;
}

http {
   # Upstream Configuration
   upstream apprise_upstream {
      server unix:/tmp/apprise/gunicorn.sock max_fails=0;
      keepalive 16;
   }
   # Basic Settings
   sendfile on;
   tcp_nopush on;
   types_hash_max_size 2048;
   include /etc/nginx/mime.types;
   default_type application/octet-stream;
   server_tokens off;

   # Upload Restriction
   client_max_body_size 500M;

   # Logging Settings
   access_log /dev/stdout;
   error_log /dev/stdout info;

	# Centralize configuration so docker containers can easily make use
	# of tmpfs mounted to /tmp
   client_body_temp_path /tmp/nginx_client_temp 1 2;
   proxy_temp_path       /tmp/nginx_proxy_temp 1 2;
   fastcgi_temp_path     /tmp/nginx_fastcgi_temp 1 2;
   uwsgi_temp_path       /tmp/nginx_uwsgi_temp 1 2;
   scgi_temp_path        /tmp/nginx_scgi_temp 1 2;

   # Gzip Settings
   gzip on;
   gzip_proxied any;
   gzip_vary on;
   gzip_min_length 1024;
   gzip_types application/json text/plain text/css application/javascript text/xml application/xml;

   # Host Configuration
   client_body_buffer_size 256k;
   client_body_in_file_only off;

   # Retry cushions
   proxy_next_upstream error timeout http_502 http_503 http_504;
   proxy_next_upstream_tries 2;

   # Rate Limiting for /status
   limit_req_zone $binary_remote_addr zone=status:10m rate=5r/s;

   server {
      listen 8000; # IPv4 Support
      listen [::]:8000; # IPv6 Support

      # Allow users to map to this file and provide their own custom
      # overrides such as
      include /etc/nginx/server-override.conf;

      # Main Website
      location / {
         proxy_pass http://apprise_upstream;
         proxy_http_version 1.1;
         proxy_set_header Connection "";

         proxy_set_header Accept-Encoding "";

         proxy_set_header Host $host;
         proxy_set_header X-Forwarded-Host $host;
         proxy_set_header X-Forwarded-Proto $scheme;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

         proxy_read_timeout 120s;

         include /etc/nginx/location-override.conf;
      }

      location = /notify {
         proxy_pass http://apprise_upstream;

         proxy_http_version 1.1;
         proxy_request_buffering off;
         proxy_set_header Connection "";

         proxy_set_header Accept-Encoding "";

         proxy_set_header Host $host;
         proxy_set_header X-Forwarded-Host $host;
         proxy_set_header X-Forwarded-Proto $scheme;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header Expect $http_expect;

         client_max_body_size 500M;
         proxy_read_timeout 300s;
         proxy_send_timeout 300s;

         include /etc/nginx/location-override.conf;
      }

      # handling of status (/status or /status/)
      location ~ ^/status/?$ {
			# normalise internally to /status/ (no client redirect)
         rewrite ^/status/?$ /status/ break;

         proxy_pass http://apprise_upstream;
         proxy_http_version 1.1;
         proxy_set_header Connection "";

         proxy_set_header Accept-Encoding "";

         proxy_set_header Host $host;
         proxy_set_header X-Forwarded-Host $host;
         proxy_set_header X-Forwarded-Proto $scheme;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

         proxy_connect_timeout 1s;
         proxy_send_timeout 2s;
         proxy_read_timeout 2s;
         proxy_buffering off;

         access_log off;
         limit_req zone=status burst=10 nodelay;
         add_header Cache-Control "no-store" always;

         include /etc/nginx/location-override.conf;
      }

      # Static Content
      location /s/ {
         root /usr/share/nginx/html;
         index index.html;
         include /etc/nginx/location-override.conf;
      }

      # 404 error handling
      error_page 404 /404.html;

      # redirect server error pages to the static page /50x.html
      error_page 500 502 503 504 /50x.html;
      location = /50x.html {
         root /usr/share/nginx/html;
      }
   }
}
